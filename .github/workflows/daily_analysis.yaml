name: Daily Stock Analysis (Italy + NASDAQ)

on:
  # Run daily at 21:00 UTC (22:00 CET / 23:00 CEST)
  schedule:
    - cron: '0 21 * * 1-5'  # Monday to Friday at 21:00 UTC (22:00 CET)

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      market:
        description: 'Market to analyze'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - italy
          - nasdaq
      max_tickers:
        description: 'Maximum number of tickers to process (0 = all)'
        required: false
        default: '0'
      single_ticker:
        description: 'Process only this ticker (leave empty for all)'
        required: false
        default: ''

permissions:
  contents: write

jobs:
  generate-notebooks:
    runs-on: ubuntu-latest
    timeout-minutes: 180  # 3 hours max for all tickers (both markets)

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install .
          pip install papermill jupyter nbconvert

      - name: Create output directories
        run: |
          mkdir -p notebooks/italy notebooks/nasdaq
          mkdir -p results/italy results/nasdaq
          mkdir -p cache

      - name: Clean results folders
        run: |
          echo "Cleaning results folders..."
          MARKET="${{ github.event.inputs.market || 'all' }}"

          if [ "$MARKET" = "all" ] || [ "$MARKET" = "italy" ]; then
            rm -f results/italy/*.csv results/italy/*.txt
            echo "Italy results folder cleaned"
          fi

          if [ "$MARKET" = "all" ] || [ "$MARKET" = "nasdaq" ]; then
            rm -f results/nasdaq/*.csv results/nasdaq/*.txt
            echo "NASDAQ results folder cleaned"
          fi

      - name: Generate Italy notebooks
        if: ${{ github.event.inputs.market == 'all' || github.event.inputs.market == 'italy' || github.event.inputs.market == '' }}
        run: |
          echo "=== Processing Italian Market ==="
          ARGS="--market italy"

          if [ "${{ github.event.inputs.single_ticker }}" != "" ]; then
            ARGS="$ARGS --ticker ${{ github.event.inputs.single_ticker }}"
          elif [ "${{ github.event.inputs.max_tickers }}" != "0" ] && [ "${{ github.event.inputs.max_tickers }}" != "" ]; then
            ARGS="$ARGS --max-tickers ${{ github.event.inputs.max_tickers }}"
          fi

          python generate_notebooks.py $ARGS

      - name: Generate NASDAQ notebooks
        if: ${{ github.event.inputs.market == 'all' || github.event.inputs.market == 'nasdaq' || github.event.inputs.market == '' }}
        run: |
          echo "=== Processing NASDAQ Market ==="
          ARGS="--market nasdaq"

          if [ "${{ github.event.inputs.single_ticker }}" != "" ]; then
            ARGS="$ARGS --ticker ${{ github.event.inputs.single_ticker }}"
          elif [ "${{ github.event.inputs.max_tickers }}" != "0" ] && [ "${{ github.event.inputs.max_tickers }}" != "" ]; then
            ARGS="$ARGS --max-tickers ${{ github.event.inputs.max_tickers }}"
          fi

          python generate_notebooks.py $ARGS

      - name: Generate consolidated reports
        run: |
          python -c "
          import pandas as pd
          import glob
          import os
          from datetime import datetime

          for market in ['italy', 'nasdaq']:
              results_dir = f'results/{market}'

              # Consolidate equity results
              equity_files = glob.glob(f'{results_dir}/*_equity.csv')
              equity_files = [f for f in equity_files if 'consolidated' not in f]

              if equity_files:
                  dfs = []
                  for f in equity_files:
                      ticker = os.path.basename(f).replace('_equity.csv', '').replace('_', '.')
                      df = pd.read_csv(f)
                      df['Ticker'] = ticker
                      dfs.append(df)

                  combined = pd.concat(dfs, ignore_index=True)
                  combined = combined.sort_values(['Ticker', 'Total Return'], ascending=[True, False])
                  combined.to_csv(f'{results_dir}/consolidated_equity.csv', index=False)
                  print(f'{market.upper()}: Consolidated {len(equity_files)} equity files')

              # Consolidate signal results
              signal_files = glob.glob(f'{results_dir}/*_signals.csv')
              signal_files = [f for f in signal_files if 'consolidated' not in f]

              if signal_files:
                  dfs = [pd.read_csv(f) for f in signal_files]
                  combined = pd.concat(dfs, ignore_index=True)
                  combined.to_csv(f'{results_dir}/consolidated_signals.csv', index=False)
                  print(f'{market.upper()}: Consolidated {len(signal_files)} signal files')

              # Create summary
              with open(f'{results_dir}/summary.txt', 'w') as f:
                  f.write(f'{market.upper()} Stock Analysis Summary\n')
                  f.write(f'Generated: {datetime.now().strftime(\"%Y-%m-%d %H:%M:%S\")}\n')
                  f.write(f'Tickers processed: {len(equity_files)}\n')
          "

      - name: Commit and push results
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"

          # Add all generated files
          git add notebooks/italy/*.ipynb || true
          git add notebooks/nasdaq/*.ipynb || true
          git add results/italy/*.csv results/italy/*.txt || true
          git add results/nasdaq/*.csv results/nasdaq/*.txt || true
          git add cache/*.parquet || true

          # Create commit with date
          DATE=$(date +%Y-%m-%d)
          git commit -m "Daily analysis: $DATE (Italy + NASDAQ)" || echo "No changes to commit"

          # Push changes
          git push origin main || echo "No changes to push"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: analysis-results-${{ github.run_number }}
          path: |
            notebooks/
            results/
          retention-days: 30

  # Optional: Send notification on failure
  notify-on-failure:
    needs: generate-notebooks
    runs-on: ubuntu-latest
    if: failure()
    steps:
      - name: Create failure summary
        run: |
          echo "## Daily Analysis Failed" >> $GITHUB_STEP_SUMMARY
          echo "The daily stock analysis workflow (Italy + NASDAQ) failed." >> $GITHUB_STEP_SUMMARY
          echo "Please check the workflow logs for details." >> $GITHUB_STEP_SUMMARY
