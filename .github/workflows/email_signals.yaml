name: Daily Trading Signals Email (Italy + NASDAQ)

on:
  schedule:
    # Run daily at 21:30 UTC (22:30 CET) - 30 min after analysis to ensure completion
    - cron: '30 21 * * 1-5'  # Monday to Friday at 21:30 UTC (22:30 CET)
  workflow_dispatch:  # Allow manual trigger

jobs:
  send-signals:
    runs-on: ubuntu-latest

    steps:
      - name: Set current date
        id: date
        run: echo "TODAY=$(date '+%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install .

      - name: Download latest results
        run: |
          # Pull latest results from the repository
          git pull origin main || true

      - name: Run Italy analysis
        id: italy_analysis
        run: |
          echo "=== Italian Market Analysis ===" > analysis_output.txt
          python analyze_results.py --market italy --export >> analysis_output.txt 2>&1

          # Copy Italy results
          cp results/italy/top_trades_recommendation.csv italy_top_trades.csv || true

      - name: Run NASDAQ analysis
        id: nasdaq_analysis
        run: |
          echo "" >> analysis_output.txt
          echo "" >> analysis_output.txt
          echo "=== NASDAQ Market Analysis ===" >> analysis_output.txt
          python analyze_results.py --market nasdaq --export >> analysis_output.txt 2>&1

          # Copy NASDAQ results
          cp results/nasdaq/top_trades_recommendation.csv nasdaq_top_trades.csv || true

      - name: Create email body
        run: |
          CURRENT_DATE=$(date '+%Y-%m-%d %H:%M:%S UTC')
          cat << EOF > email_body.html
          <!DOCTYPE html>
          <html>
          <head>
            <style>
              body { font-family: 'Courier New', monospace; background-color: #1a1a2e; color: #eaeaea; padding: 20px; }
              .container { max-width: 900px; margin: 0 auto; }
              h1 { color: #4ecca3; border-bottom: 2px solid #4ecca3; padding-bottom: 10px; }
              h2 { color: #00d9ff; margin-top: 30px; }
              .market-section { margin: 30px 0; padding: 20px; border: 1px solid #4ecca3; border-radius: 10px; }
              .italy { border-color: #00ff88; }
              .nasdaq { border-color: #ff6b6b; }
              .signal-long { color: #00ff88; font-weight: bold; }
              .signal-short { color: #ff6b6b; font-weight: bold; }
              table { border-collapse: collapse; width: 100%; margin: 20px 0; }
              th, td { border: 1px solid #4ecca3; padding: 12px; text-align: left; }
              th { background-color: #16213e; color: #4ecca3; }
              tr:nth-child(even) { background-color: #1f1f3d; }
              .disclaimer { font-size: 12px; color: #888; margin-top: 30px; padding: 15px; border: 1px solid #444; }
              pre { background-color: #0f0f23; padding: 15px; overflow-x: auto; border-radius: 5px; font-size: 11px; }
            </style>
          </head>
          <body>
            <div class="container">
              <h1>Daily Trading Signals - Italy + NASDAQ</h1>
              <p>Generated: ${CURRENT_DATE}</p>

              <h2>Analysis Report</h2>
              <pre>
          EOF

          cat analysis_output.txt >> email_body.html

          cat << 'EOF' >> email_body.html
              </pre>

              <div class="disclaimer">
                <strong>DISCLAIMER:</strong> This is an automated analysis based on historical data and technical indicators.
                Past performance does not guarantee future results. Always do your own research and manage risk appropriately.
                This is not financial advice.
              </div>

              <p style="color: #666; font-size: 11px; margin-top: 20px;">
                Sent automatically by <a href="https://github.com/${{ github.repository }}" style="color: #4ecca3;">algoshort</a> GitHub Actions
              </p>
            </div>
          </body>
          </html>
          EOF

      - name: Send email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.GMAIL_USERNAME }}
          password: ${{ secrets.GMAIL_APP_PASSWORD }}
          subject: "Daily Trading Signals (Italy + NASDAQ) - ${{ steps.date.outputs.TODAY }}"
          to: ${{ secrets.EMAIL_RECIPIENT }}
          from: ${{ secrets.GMAIL_USERNAME }}
          html_body: file://email_body.html
          attachments: italy_top_trades.csv,nasdaq_top_trades.csv

      - name: Notify success
        if: success()
        run: echo "Email sent successfully with Italy + NASDAQ signals"

      - name: Notify failure
        if: failure()
        run: echo "Failed to send email. Check your SMTP credentials and secrets configuration."
